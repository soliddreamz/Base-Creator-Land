<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Creator Dashboard</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{--bg:#0b0b0f;--panel:#11111a;--text:#e9e9f2;--muted:#a7a7bd;--line:#232334;--good:#2dd4bf;--radius:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:18px 14px 40px}
    .top{border:1px solid var(--line);border-radius:var(--radius);padding:12px;background:rgba(255,255,255,.02);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .top strong{font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:rgba(255,255,255,.02);font-size:13px;color:var(--text);text-decoration:none}
    .btn:hover{background:rgba(255,255,255,.04)}
    .grid{margin-top:12px;display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);border-radius:var(--radius);padding:14px;background:rgba(255,255,255,.02)}
    h2{margin:0 0 8px;font-size:14px}
    .muted{color:var(--muted);font-size:13px;line-height:1.4}
    input, textarea, select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.22);color:var(--text);font-size:13px}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text)}
    .toggle input{width:auto}
    .save{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#151522;color:var(--text);font-size:13px;cursor:pointer}
    button.primary{border-color:var(--good);background:#0f2f2a}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <strong>Creator Dashboard</strong>
        <div class="muted" style="font-size:12px">Writes local state only • No backend • No platform</div>
      </div>
      <div class="row">
        <a class="btn" href="index.html">Open App</a>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Status</h2>
        <div class="muted" id="headline">Loading…</div>
        <div class="hr"></div>
        <label class="muted" style="display:block;margin:0 0 6px">Live Status</label>
        <select id="live_status">
          <option value="offline">offline</option>
          <option value="testing">testing</option>
          <option value="live">live</option>
        </select>
        <div style="height:10px"></div>
        <label class="muted" style="display:block;margin:0 0 6px">Live Status Text (creator-facing)</label>
        <input id="live_status_text" placeholder="Example: Testing routing. No backend." />
      </section>

      <section class="card">
        <h2>Sections</h2>
        <p class="muted">These switches control what the public app shows.</p>
        <div class="row">
          <label class="toggle"><input type="checkbox" id="show_media"> Media</label>
          <label class="toggle"><input type="checkbox" id="show_social"> Social</label>
          <label class="toggle"><input type="checkbox" id="live_enabled"> Live</label>
          <label class="toggle"><input type="checkbox" id="archive_enabled"> Archive</label>
        </div>
        <div class="hr"></div>
        <label class="muted" style="display:block;margin:0 0 6px">Live Stream URL (fan-facing when Live is enabled)</label>
        <input id="stream_url" placeholder="Paste stream/watch URL here" />
        <div class="muted" style="font-size:12px;margin-top:8px">
          This does not start the stream. It only controls the link shown at <code>/index.html</code>.
        </div>
      </section>

      <section class="card">
        <h2>Theme</h2>
        <p class="muted">Applies to the public app immediately on this device.</p>
        <label class="muted" style="display:block;margin:0 0 6px">Background</label>
        <input type="color" id="bg_color" />
        <div style="height:10px"></div>
        <label class="muted" style="display:block;margin:0 0 6px">Accent (text)</label>
        <input type="color" id="accent_color" />
      </section>

      <section class="card">
        <h2>Notes</h2>
        <p class="muted">Private session notes. Stored locally.</p>
        <textarea id="notes"></textarea>
      </section>
    </div>

    <div class="save">
      <button class="primary" id="saveBtn">Save</button>
      <button id="resetBtn">Reset to Defaults</button>
      <span class="muted" id="saveMsg" style="align-self:center"></span>
    </div>
  </div>

  <script>
    const OVERRIDE_KEY = "creatorOverrides_v1";

    function today(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function loadOverrides(){
      try { return JSON.parse(localStorage.getItem(OVERRIDE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveOverrides(obj){
      localStorage.setItem(OVERRIDE_KEY, JSON.stringify(obj));
    }
    function clearOverrides(){
      localStorage.removeItem(OVERRIDE_KEY);
    }

    async function loadBase(){
      const res = await fetch("./content.json", { cache:"no-store" });
      return res.json();
    }

    function deepMergeCreator(baseCreator, overrides){
      const merged = { ...baseCreator, ...overrides };
      merged.controls = {
        ...(baseCreator.controls || {}),
        ...(overrides.controls || {})
      };
      merged.controls.theme = {
        ...((baseCreator.controls||{}).theme || {}),
        ...((overrides.controls||{}).theme || {})
      };
      merged.controls.sections = {
        ...((baseCreator.controls||{}).sections || {}),
        ...((overrides.controls||{}).sections || {})
      };
      return merged;
    }

    function setMsg(s){ document.getElementById("saveMsg").textContent = s || ""; }

    async function boot(){
      const base = await loadBase();
      const baseCreator = base.creator || {};
      const overrides = loadOverrides();
      const creator = deepMergeCreator(baseCreator, overrides);

      document.getElementById("headline").textContent = creator.headline || "—";

      live_status.value = creator.live_status || "offline";
      live_status_text.value = creator.live_status_text || "";

      const sec = creator.controls?.sections || {};
      show_media.checked = sec.show_media !== false;
      show_social.checked = sec.show_social !== false;
      live_enabled.checked = !!sec.live_enabled;
      archive_enabled.checked = !!sec.archive_enabled;

      // Stream URL: stored as override in a top-level field to avoid mutating shipped fan content
      stream_url.value = creator.stream_url || (base.fan?.live?.stream_url || "") || "";

      const theme = creator.controls?.theme || {};
      bg_color.value = theme.background || "#0b0b0f";
      accent_color.value = theme.accent || "#e9e9f2";

      notes.value = creator.notes || "";

      setMsg("");
    }

    function buildOverrides(){
      return {
        live_status: live_status.value,
        live_status_text: live_status_text.value,
        notes: notes.value,
        updated: today(),

        // store stream_url as creator override (fan reads it if present)
        stream_url: stream_url.value.trim(),

        controls: {
          theme: {
            background: bg_color.value,
            accent: accent_color.value
          },
          sections: {
            show_media: show_media.checked,
            show_social: show_social.checked,
            live_enabled: live_enabled.checked,
            archive_enabled: archive_enabled.checked
          }
        }
      };
    }

    document.getElementById("saveBtn").addEventListener("click", () => {
      const o = buildOverrides();
      saveOverrides(o);
      setMsg("Saved. Open the app to see changes.");
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      clearOverrides();
      setMsg("Reset to defaults.");
      boot();
    });

    boot().catch(() => {
      document.getElementById("headline").textContent = "Could not load content.json";
    });
  </script>
</body>
</html>
